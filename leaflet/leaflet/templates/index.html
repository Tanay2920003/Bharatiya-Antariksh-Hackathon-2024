<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask + Leaflet</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='leaflet.css') }}" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
        }
        html, body {
            height: 100%;
            margin: 0;
        }
        #map {
            height: 100%;
            width: 100%;
            position: relative;
        }
        .button-container, .search-container, .grid-button-container , .ai-button-container{
            position: absolute;
            z-index: 1000;
        }
        .button-container {
            bottom: 10px;
            left: 10px;
        }
        .search-container {
            top: 10px;
            left: 10px;
            right: 10px;
        }
        .grid-button-container {
            top: 65%;
            right: 25px;
            transform: translateY(-50%);
        }
        .ai-button-container {
            top: 75%;
            right: 22px;
            transform: translateY(-50%);
        }
        .button-container button, .search-container input , .grid-button-container button ,.ai-button-container button  {
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .button-container button {
            background-color: #007BFF;
            color: white;
        }
        .button-container button:hover {
            background-color: #0056b3;
        }
        .search-container input {
            width: 95%;
            margin-left: 30px;
            border-radius: 40px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .grid-button-container button {
            background-color: #007BFF;
            color: white;
        }
        .grid-button-container button:hover {
            background-color: #0056b3;
        }
        .ai-button-container button {
            background-color: #007BFF;
            color: white;
        }
        .ai-button-container button:hover {
            background-color: #0056b3;
        }
        /* Custom CSS for the scale control */
        .leaflet-control-scale {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: white;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        /* Styles for dropdown menu */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            bottom: 100%; /* Position the dropdown above the button */
            left: 0;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 5px;
            width: 200px;
            padding: 0;
        }
        .dropdown-content > div {
            position: relative;
        }
        .dropdown-content > div:hover .submenu {
            display: block;
        }
        .dropdown-content button {
            display: block;
            width: 100%;
            border: none;
            padding: 10px;
            text-align: left;
            background-color: #007BFF;
            color: white;
            border-bottom: 1px solid #0056b3;
            cursor: pointer;
        }
        .dropdown-content button:last-child {
            border-bottom: none;
        }
        .dropdown-content button:hover {
            background-color: #0056b3;
        }
        .submenu {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 5px;
            width: 200px;
            padding: 0;
        }
        .submenu button {
            border-bottom: 1px solid #0056b3;
        }
        .submenu button:last-child {
            border-bottom: none;
        }
        .submenu button:hover {
            background-color: #0056b3;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        /* Style for the popup button */
        .popup-button {
            position: absolute;
            top: 92%;
            left: 25%;
            background-color: #4CAF50; /* Green */
            border: none;
            color: white;
            border-radius: 10px;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            z-index: 1001; /* Ensure it's above the map */
        }

        /* The actual popup */
        .popup .popuptext {
            visibility: hidden;
            width: 250px;
            height: 50px;
            background-color: #4CAF50;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 0;
            position: absolute;
            z-index: 1002; /* Ensure it's above the map */
            left: 40%;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* Toggle this class - hide and show the popup */
        .popup .show {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="popup">
        <button class="popup-button" onclick="myFunction()">GEOSAGE</button>
        <span class="popuptext" id="myPopup"><p>Welcome to </p><p> GEOSAGE! </p></span>
    </div>
    <div class="search-container">
        <input id="searchInput" type="text" placeholder="Search for a place or coordinates..." onkeydown="if(event.key === 'Enter'){search();}">
    </div>
    <div id="map" class="leaflet-container"></div>

    <div class="grid-button-container">
        <button onclick="toggleBackground()">#</button> <!-- Grid icon -->
    </div>
    <script src="https://cdn.userway.org/widget.js" data-account="aDJM4sQbtW"></script>
    <div class="ai-button-container">
        <img onclick="toggleBackground()" src="https://img.icons8.com/?size=100&id=2f8efjyRWNVz&format=png&color=000000" alt="Grid icon">
    </div>

    <div class="button-container">
        <div class="dropdown">
            <button>Layers</button>
            <div class="dropdown-content">
                <button onclick="toggleLayer('landCover')">Land Cover / Land Use</button>
                <button onclick="toggleLayer('glacialLakes')">Glacial Lakes / Water Bodies</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='leaflet.js') }}"></script>
    <script>
        var map = L.map('map').setView([20.59, 78.96], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18,
        }).addTo(map);

        var layers = {
            landCover: L.tileLayer.wms("https://bhuvan-ras2.nrsc.gov.in/cgi-bin/LULC250K.exe", {
                layers: 'LULC250K_2223',
                format: 'image/png',
                transparent: true,
                attribution: 'Bhoonidhi/Bhuvan WMS service'
            }),
            glacialLakes: L.tileLayer.wms("https://bhuvan-vec2.nrsc.gov.in/bhuvan/wms", {
                layers: 'Indianhimalayas:indianhimalayas_GLWB',
                format: 'image/png',
                transparent: true,
                attribution: 'Bhoonidhi/Bhuvan WMS service'
            }),
        };


        var marker;  // Variable to store the marker
        var customIcon = L.icon({
            iconUrl: '{{ url_for('static', filename='images/marker2x.png') }}',  // Path to your custom icon
            iconSize: [38, 60],                // Size of the icon
            iconAnchor: [19, 60],              // Anchor point of the icon
            popupAnchor: [0, -60]              // Anchor point of the popup relative to the icon
        });

        fetchMarkers();

        function fetchMarkers() {
            fetch('/markers')
                .then(response => response.json())
                .then(data => {
                    data.forEach(markerData => {
                        var marker = L.marker([markerData.lat, markerData.lng], {icon: customIcon}).addTo(map);
                        marker.bindPopup(markerData.description);
                    });
                })
                .catch(error => console.error('Error fetching markers:', error));
        }

        function search() {
            var input = document.getElementById('searchInput').value;
            if (input) {
                if (input.includes(',')) {
                    var coords = input.split(',').map(Number);
                    if (coords.length === 2) {
                        map.setView(coords, 13);
                    } else {
                        alert('Invalid coordinates. Please enter as "lat,lng".');
                    }
                } else {
                    fetch(`https://nominatim.openstreetmap.org/search?q=${input}&format=json&limit=1`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.length > 0) {
                                var bbox = data[0].boundingbox.map(Number);
                                map.fitBounds([[bbox[0], bbox[2]], [bbox[1], bbox[3]]]);
                            } else {
                                alert('Location not found.');
                            }
                        })
                        .catch(error => console.error('Error searching location:', error));
                }
            } else {
                alert('Please enter a place name or coordinates.');
            }
        }

        function toggleLayer(layerName) {
            var layer = layers[layerName];
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            } else {
                map.addLayer(layer);
            }
        }

        // Add scale control to the map
        L.control.scale().addTo(map);

        // Popup button functionality
        function myFunction() {
            var popup = document.getElementById("myPopup");
            popup.classList.toggle("show");
        }

        function toggleBackground() {
            var mapElement = document.getElementById('map');
            var currentBackgroundColor = mapElement.style.backgroundColor;
            mapElement.style.backgroundColor = currentBackgroundColor === 'transparent' ? 'rgba(0, 0, 0, 0.5)' : 'transparent';
        }

        // Automatically show popup after 2 seconds and hide after 3 seconds
        window.onload = function() {
            setTimeout(function() {
                var popup = document.getElementById("myPopup");
                popup.classList.add("show");
                setTimeout(function() {
                    popup.classList.remove("show");
                }, 3000); // Hide after 3 seconds
            }, 2000); // Show after 2 seconds
        };
    </script>
</body>
</html>
